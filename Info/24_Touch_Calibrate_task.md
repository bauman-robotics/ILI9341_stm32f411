# План реализации калибровки тачскрина

## Обзор
Реализовать функционал калибровки тачскрина для STM32 с ILI9341 дисплеем. Калибровка позволит корректировать координаты касаний для точного позиционирования.

## Требуемые изменения

### 1. Добавление параметра активации калибровки в конфиг файл
- В файле `Core/Inc/config.h` добавить новый параметр, например:
  ```c
  #define TOUCHSCREEN_CALIBRATION_ENABLED 1  // 1 - включена, 0 - отключена
  ```
- Этот параметр будет контролировать доступность режима калибровки.

### 2. Реализация функции калибровки
- Создать новую функцию в файле `Core/Src/touch.c` или отдельном модуле для калибровки.
- Функция должна:
  - Проверять флаг `TOUCHSCREEN_CALIBRATION_ENABLED`
  - Инициировать режим калибровки при активации

### 3. Последовательный вывод калибровочных точек
- Использовать ILI9341 драйвер для рисования точек на дисплее в известных координатах.
- Типичные точки калибровки: углы дисплея + центр (например, (10,10), (310,10), (10,230), (310,230), (160,120)).
- Каждая точка отображается последовательно с задержкой для пользовательского ввода.

### 4. Обработка прерываний от тачскрина
- В обработчике прерываний тачскрина (`touch.c`) добавить логику сбора данных во время калибровки.
- При касании точки фиксировать сырые координаты ADC тачскрина.
- Переходить к следующей точке после каждого касания.

### 5. Вычисление калибровочных коэффициентов
- Использовать собранные данные (сырые координаты -> известные экранные координаты).
- Реализовать алгоритм расчета матрицы преобразования (3-точечная или 5-точечная калибровка).
- Формула для простого линейного преобразования:
  ```
  X_screen = (X_raw - X_offset) * X_scale
  Y_screen = (Y_raw - Y_offset) * Y_scale
  ```
- Для более точной калибровки использовать аффинное преобразование.

### 6. Вывод коэффициентов в консольный лог
- Использовать logger (`Core/Inc/logger.h`) для вывода рассчитанных коэффициентов.
- Формат вывода:
  ```
  Touch calibration coefficients:
  X_offset: 123
  X_scale: 0.456
  Y_offset: 789
  Y_scale: 0.012
  ```
- Эти значения должны быть сохранены в конфиг файле как константы для постоянного использования.

## Алгоритм работы
1. Активация режима калибровки через конфиг параметр.
2. Отображение первой калибровочной точки.
3. Ожидание касания и фиксация координат.
4. Повтор для всех точек.
5. Расчет коэффициентов на основе собранных данных.
6. Вывод коэффициентов в лог для ручного сохранения в код.

## Дополнительные соображения
- Добавить визуальную обратную связь (например, изменение цвета точки после касания).
- Реализовать таймауты для предотвращения зависания.
- Обеспечить возможность выхода из режима калибровки без сохранения.
- Протестировать на различных устройствах для учета вариаций в производстве тачскринов.

## Текущая ориентация экрана, ландшафтное расположение, нулевая позиция - правый нижний угол. 
