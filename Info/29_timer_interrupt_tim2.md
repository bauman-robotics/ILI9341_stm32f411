# 29. Анализ проблемы с прерыванием от таймера TIM2

## Введение
После изменения Timebase Source на TIM2 в STM32CubeMX проблема сохранилась: при запуске кода программа оказывается в прерывании от таймера TIM2. Логи Cortex-Debug показывают остановку в `TIM2_IRQHandler`, который вызывает `HAL_TIM_IRQHandler`.

## Анализ логов Cortex-Debug
Из предоставленных логов видно следующее:

### Ключевые моменты из логов:
- Программа останавливается по адресу `0x22594710` (в стеке прерывания).
- Стек вызовов:
  1. Уровень 0: `?? ()` по адресу `0x22594710`
  2. Уровень 1: `<signal handler called>`
  3. Уровень 2: `HAL_TIM_IRQHandler` в `stm32f4xx_hal_tim.c:3825`
  4. Уровень 3: `TIM2_IRQHandler` в `stm32f4xx_it.c:186`
  5. Уровень 4: `<signal handler called>`
  6. Уровень 5: `Reset_Handler` в `startup_stm32f411xe.s:61`

- После `exec-continue` программа продолжает работать, но `backtrace` показывает "Selected thread is running."

### Вывод из логов:
Программа останавливается в прерывании TIM2 сразу после подключения отладчика. Это указывает на то, что TIM2 генерирует прерывания, и отладчик ловит их.

## Анализ кода
### Конфигурация таймеров в проекте:
- **HAL (библиотека STM32)** теперь использует **TIM2** как источник времени (timebase) для `HAL_Delay()`, `HAL_GetTick()`. В `Core/Src/stm32f4xx_it.c`:
  - `TIM2_IRQHandler` вызывает `HAL_TIM_IRQHandler(&htim2)`.

- **FreeRTOS** по-прежнему использует **SysTick**. В `Core/Inc/FreeRTOSConfig.h`:
  - `#define xPortSysTickHandler SysTick_Handler`
  - Приоритет SysTick: низкий (240).

### Причина проблемы:
Та же, что и с TIM1: TIM2 начинает генерировать прерывания каждые 1 мс сразу после `HAL_Init()`, ещё до запуска FreeRTOS. Прерывания TIM2 имеют высокий приоритет, поэтому отладчик останавливается в них.

## Решения
Проблема не решена, так как выбор TIM2 вместо TIM1 не устранил конфликт. Нужно выбрать другой таймер, например TIM3 или TIM4, или применить другие решения из файла `28_timer_interrupt_analysis.md`.

### Рекомендация:
- В STM32CubeMX измените Timebase Source на TIM3, TIM4 или другой свободный таймер (не SysTick).
- Перегенерируйте код.
- Если TIM2 используется для других целей, перенесите функции на другой таймер.

Если проблема сохранится, примените альтернативные решения (снижение приоритета, отключение и т.д.).
