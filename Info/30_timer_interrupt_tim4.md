# 30. Анализ проблемы с прерыванием от таймера TIM4

## Введение
После изменения Timebase Source на TIM4 проблема сохранилась: программа останавливается в прерывании TIM4. Это подтверждает, что выбор любого TIMx для HAL timebase приводит к тому же конфликту с SysTick от FreeRTOS.

## Анализ логов
- Стек: HAL_TIM_IRQHandler (htim=0x200005c4 <htim4>), TIM4_IRQHandler.
- Backtrace показывает остановку в TIM4_IRQHandler.

## Причина
Любой таймер, используемый HAL для timebase, генерирует прерывания с высоким приоритетом (0) до запуска FreeRTOS, что вызывает остановку отладчика.

## Решение: Снизить приоритет прерывания TIM4
Поскольку выбор другого таймера не помог, нужно снизить приоритет TIM4, чтобы он не прерывал отладку.

### Шаги:
1. В файле `Core/Src/stm32f4xx_hal_timebase_tim.c`, в функции `HAL_InitTick()`:
   - Измените `HAL_NVIC_SetPriority(TIM4_IRQn, TickPriority, 0U);` на `HAL_NVIC_SetPriority(TIM4_IRQn, 15, 0U);` (низкий приоритет).

2. Или в CubeMX установите более низкий приоритет для TIM4_IRQn.

3. Перекомпилируйте и протестируйте.

### Альтернатива: Отключить прерывания HAL timebase
В `HAL_InitTick()` закомментируйте `HAL_TIM_Base_Start_IT(&htim4);`, но тогда `HAL_Delay()` может не работать.

### Заключение
Проблема в высоком приоритете прерываний HAL timebase. Снижение приоритета TIM4 должно решить проблему отладки.
