# –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Ç–∞—á—Å–∫—Ä–∏–Ω–∞ MSP2807

## üì± –û–±–∑–æ—Ä

–ü—Ä–æ–µ–∫—Ç –≤–∫–ª—é—á–∞–µ—Ç –ø–æ–ª–Ω—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É —Ç–∞—á—Å–∫—Ä–∏–Ω–∞ MSP2807 —Å SPI –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º. –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è, —á—Ç–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –∏ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ.

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏

- **–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä**: MSP2807
- **–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ**: 320√ó240 —Ç–æ—á–µ–∫ (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –¥–∏—Å–ø–ª–µ—é)
- **–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å**: SPI2
- **–ü—Ä–µ—Ä—ã–≤–∞–Ω–∏—è**: –î–∞ (PB9)
- **–î–∞–≤–ª–µ–Ω–∏–µ**: 12-bit ADC (0-4095)

## üì° –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

```
STM32F411          MSP2807
PB10 (SPI2_SCK) ‚îÄ‚îÄ‚ñ∫ T_CLK
PB14 (SPI2_MISO) ‚îÄ‚îÄ‚ñ∫ T_DO
PB15 (SPI2_MOSI) ‚îÄ‚îÄ‚ñ∫ T_DIN
PB13 (SPI2_CS)  ‚îÄ‚îÄ‚ñ∫ T_CS
PB9  (IRQ)      ‚îÄ‚îÄ‚ñ∫ T_IRQ
GND              ‚îÄ‚îÄ‚ñ∫ GND
3.3V             ‚îÄ‚îÄ‚ñ∫ VCC
```

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –í config.h:
```c
#define ENABLE_TOUCHSCREEN 1     // –í–∫–ª—é—á–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É —Ç–∞—á—Å–∫—Ä–∏–Ω–∞
#define ENABLE_TOUCH_DEBUG 1     // –í–∫–ª—é—á–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
```

### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:
```c
TOUCH_Init();  // –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ TouchTask
```

## üîç API —Ñ—É–Ω–∫—Ü–∏–π

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
```c
void TOUCH_Init(void);                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∞—á—Å–∫—Ä–∏–Ω–∞
uint8_t TOUCH_IsTouched(void);            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—Å–∞–Ω–∏—è
uint8_t TOUCH_ReadData(touch_data_t *data); // –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
void TOUCH_ProcessInterrupt(void);        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è
```

### –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
```c
uint16_t TOUCH_ReadADC(uint8_t channel);  // –ß—Ç–µ–Ω–∏–µ ADC –∫–∞–Ω–∞–ª–∞
uint16_t TOUCH_ReadX(void);               // –ß—Ç–µ–Ω–∏–µ X –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
uint16_t TOUCH_ReadY(void);               // –ß—Ç–µ–Ω–∏–µ Y –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
uint16_t TOUCH_ReadPressure(void);        // –ß—Ç–µ–Ω–∏–µ –¥–∞–≤–ª–µ–Ω–∏—è
```

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct {
    uint16_t x;        // X –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ (0-320)
    uint16_t y;        // Y –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ (0-240)
    uint16_t pressure; // –î–∞–≤–ª–µ–Ω–∏–µ (0-4095)
    touch_event_t event; // –¢–∏–ø —Å–æ–±—ã—Ç–∏—è
    uint32_t timestamp;   // –í—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞
} touch_data_t;

typedef enum {
    TOUCH_EVENT_NONE = 0,    // –ù–µ—Ç —Å–æ–±—ã—Ç–∏—è
    TOUCH_EVENT_PRESS,       // –ö–∞—Å–∞–Ω–∏–µ
    TOUCH_EVENT_RELEASE,     // –û—Ç–ø—É—Å–∫–∞–Ω–∏–µ
    TOUCH_EVENT_MOVE         // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
} touch_event_t;
```

## üéÆ FreeRTOS –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### TouchTask:
```c
void TouchTask(void const * argument) {
    LOG_SendString("TOUCH: TouchTask started\r\n");

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    TOUCH_Init();

    while (1) {
        if (TOUCH_IsTouched()) {
            osDelay(10); // –î–µ–±–∞—É–Ω—Å

            if (TOUCH_IsTouched()) {
                touch_data_t data;
                if (TOUCH_ReadData(&data)) {
                    #if ENABLE_TOUCH_DEBUG
                    LOG_Printf("TOUCH: X=%d, Y=%d, P=%d, E=%d\r\n",
                               data.x, data.y, data.pressure, data.event);
                    #endif

                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
                    // TODO: –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫–Ω–æ–ø–∫–∏
                }
            }
        }

        osDelay(50); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∑–∞—Ö–≤–∞—Ç–∞ CPU
    }
}
```

### –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏—è:
```c
void EXTI9_5_IRQHandler(void) {
    HAL_GPIO_EXTI_IRQHandler(TOUCH_IRQ_Pin);

    #if ENABLE_TOUCHSCREEN
    TOUCH_ProcessInterrupt();  // –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–∏
    #endif
}
```

## üîß MSP2807 –ø—Ä–æ—Ç–æ–∫–æ–ª

### –ö–æ–º–∞–Ω–¥—ã ADC:
- **–ö–∞–Ω–∞–ª 5**: X –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞
- **–ö–∞–Ω–∞–ª 1**: Y –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞
- **–ö–∞–Ω–∞–ª 3**: –î–∞–≤–ª–µ–Ω–∏–µ (Z1/Z2)

### –§–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã:
```
START (1) | CHANNEL (3 –±–∏—Ç) | MODE (1 –±–∏—Ç)
```

### –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö:
1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É (3 –±–∞–π—Ç–∞)
2. –ü—Ä–æ—á–∏—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç (3 –±–∞–π—Ç–∞)
3. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ 12-bit –∑–Ω–∞—á–µ–Ω–∏–µ

## üìà –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞

### –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:
```c
// –ü—Ä–æ—Å—Ç–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ (—Ç—Ä–µ–±—É–µ—Ç –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏)
data->x = (x_raw * TOUCH_MAX_X) / 4096;
data->y = (y_raw * TOUCH_MAX_Y) / 4096;
```

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∫–∞–ª–∏–±—Ä–æ–≤–∫–µ:
1. –°–æ–±—Ä–∞—Ç—å —Ç–æ—á–∫–∏ –ø–æ —É–≥–ª–∞–º —ç–∫—Ä–∞–Ω–∞
2. –í—ã—á–∏—Å–ª–∏—Ç—å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
3. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ EEPROM/Flash
4. –ü—Ä–∏–º–µ–Ω—è—Ç—å –ø—Ä–∏ –∫–∞–∂–¥–æ–º —á—Ç–µ–Ω–∏–∏

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –õ–æ–≥–∏ –≤–∫–ª—é—á–µ–Ω–∏—è:
```c
#define ENABLE_TOUCH_DEBUG 1
```

### –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:
```
TOUCH: TouchTask started
TOUCH: MSP2807 touchscreen initialized
TOUCH: X=150, Y=200, Pressure=3500, Event=1
TOUCH: X=145, Y=195, Pressure=3200, Event=2
```

### –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

#### üö® **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞: TOUCH_Init() –≤—ã–∑—ã–≤–∞–µ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏–µ**
**–°–∏–º–ø—Ç–æ–º—ã:**
- –ö–æ–¥ –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
- –ë–µ–∑ —Ç–∞—á—Å–∫—Ä–∏–Ω–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ
- –ü—Ä–∏ –≤—ã–∑–æ–≤–µ TOUCH_Init() —Å–∏—Å—Ç–µ–º–∞ –∑–∞–≤–∏—Å–∞–µ—Ç
- –ù–µ—Ç –ª–æ–≥–æ–≤, —ç–∫—Ä–∞–Ω –ø—É—Å—Ç–æ–π, SPI —Å–∏–≥–Ω–∞–ª–æ–≤ –Ω–µ—Ç

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
1. **–ö–æ–Ω—Ñ–ª–∏–∫—Ç GPIO –ø–∏–Ω–æ–≤** - TOUCH_IRQ_PIN (PB9) –∏–ª–∏ TOUCH_CS_PIN (PB13) –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç
2. **HAL_GPIO_Init() –æ—à–∏–±–∫–∞** - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–∏–Ω–æ–≤
3. **HAL_NVIC_EnableIRQ() –æ—à–∏–±–∫–∞** - –ø—Ä–æ–±–ª–µ–º–∞ —Å –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è–º–∏
4. **MSP2807 –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω** - –Ω–æ –∫–æ–¥ –ø—ã—Ç–∞–µ—Ç—Å—è –µ–≥–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å

**–†–µ—à–µ–Ω–∏–µ:**
- –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å —Ç–∞—á—Å–∫—Ä–∏–Ω
- –ò—Å–ø—Ä–∞–≤–∏—Ç—å GPIO –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã
- –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ MSP2807
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —á–∞—Å—Ç—è–º (—Å–Ω–∞—á–∞–ª–∞ GPIO, –ø–æ—Ç–æ–º –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è, –ø–æ—Ç–æ–º SPI)

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –ö–æ—Ä–æ—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ:
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ hardware
- [ ] –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ:
- [ ] –ú—É–ª—å—Ç–∏—Ç–∞—á –ø–æ–¥–¥–µ—Ä–∂–∫–∞
- [ ] –ñ–µ—Å—Ç—ã (swipe, pinch)
- [ ] –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —à—É–º–æ–≤
- [ ] –≠–Ω–µ—Ä–≥–æ—Å–±–µ—Ä–µ–∂–µ–Ω–∏–µ

## üìã –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### SPI –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:
- **–†–µ–∂–∏–º**: Master
- **–°–∫–æ—Ä–æ—Å—Ç—å**: –î–æ 1MHz (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç MSP2807)
- **–ë–∏—Ç—ã**: 8-bit
- **–ü–æ—Ä—è–¥–æ–∫**: MSB first

### –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏—è:
- **–õ–∏–Ω–∏—è**: EXTI9_5
- **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: 5
- **–¢—Ä–∏–≥–≥–µ—Ä**: Falling edge

### –ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ:
- **–ê–∫—Ç–∏–≤–Ω–æ–µ**: ~2mA
- **–°–ø—è—â–µ–µ**: <1mA

## üîó –°—Å—ã–ª–∫–∏

- [MSP2807 Datasheet](https://www.datasheet-pdf.com/datasheet/MSP2807.html)
- [ILI9341 Touch Integration](https://www.displayfuture.com/Display/datasheet/controller/ILI9341.pdf)

---

**–¢–∞—á—Å–∫—Ä–∏–Ω MSP2807 –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ –ø—Ä–æ–µ–∫—Ç!** üì±‚ú®
