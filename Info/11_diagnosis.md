# Диагностика ошибки отладки STM32F411: Анализ логов и выявление проблемы

## Анализ предоставленных логов

### Ручной запуск OpenOCD с проектым конфигом
```
openocd -f /home/ypc/projects/stm32/ILI9341_project/ILI9341_stm32f411/openocd.cfg
```
**Результат:** Успешный запуск
- ST-Link V2 распознан (VID:PID 0483:3748)
- Напряжение питания: 3.137032V (нормально)
- Процессор Cortex-M4 обнаружен
- Сервер GDB запущен на порту **3333**
- TCL порт: 6666
- Telnet порт: 4444
- Semihosting включен

### Проверка lsusb
ST-Link подключен: `Bus 003 Device 004: ID 0483:3748 STMicroelectronics ST-LINK/V2`

### Проверка netstat
На порту 50000 нет активных процессов.

### Ручной запуск с дефолтными конфигами
```
openocd -f interface/stlink.cfg -f target/stm32f4x.cfg
```
**Результат:** Ошибка `Address already in use` на порту 6666 - потому что первый экземпляр OpenOCD уже запущен и занимает этот порт.

## Выявленная проблема: Конфликт портов

### Анализ openocd.cfg
Файл `openocd.cfg` содержит:
```cfg
gdb_port 3333
telnet_port 4444
tcl_port 6666
```

### Конфигурация Cortex-Debug в VS Code
В команде запуска OpenOCD используются параметры:
- `-c "gdb_port 50000"`
- `-c "tcl_port 50001"`
- `-c "telnet_port 50002"`

**Порядок выполнения:**
1. VS Code устанавливает порты 50000/50001/50002 через `-c` параметры
2. Затем загружается `openocd.cfg`
3. `openocd.cfg` **переопределяет** порты обратно на 3333/6666/4444

**Результат:** OpenOCD слушает на порту 3333, но GDB пытается подключиться к порту 50000 → **Connection timeout**

## Дальнейшие шаги для исправления

### Вариант 1: Изменить openocd.cfg (Рекомендуется)
Удалить или закомментировать строки с портами в `openocd.cfg`:
```cfg
# gdb_port 3333
# telnet_port 4444
# tcl_port 6666
```
Тогда будут использоваться порты, установленные Cortex-Debug (50000/50001/50002).

### Вариант 2: Изменить launch.json
Изменить конфигурацию в `.vscode/launch.json` для использования портов из `openocd.cfg`:
```json
"gdbPort": 3333,
"tclPort": 6666,
"telnetPort": 4444
```
(Примечание: Синтаксис может отличаться, проверить документацию Cortex-Debug)

### Вариант 3: Использовать флаги в openocd.cfg
Добавить в конец `openocd.cfg`:
```cfg
gdb_port 50000
tcl_port 50001
telnet_port 50002
```
Это переопределит порты после загрузки стандартных конфигов.

### Проверка исправления
1. Остановить все экземпляры OpenOCD
2. Внести изменения в конфигурацию
3. Запустить отладку в VS Code (F5)
4. Проверить логи на успешное подключение к порту 50000

### Дополнительные рекомендации
- Убедиться, что нет других экземпляров OpenOCD запущенных
- Проверить логи в терминале gdb-server в VS Code
- При необходимости перезагрузить VS Code после изменений конфигурации
