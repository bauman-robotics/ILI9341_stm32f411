# Проблема выхода из отладки в VSCode

## Описание проблемы

Пользователь не может завершить сеанс отладки в VSCode при использовании Cortex-Debug. При нажатии кнопки "Stop" отладчик зависает и не завершается корректно.

## Причина проблемы

### 1. HardFault в целевом устройстве
- Программа попадает в HardFault сразу после запуска FreeRTOS
- GDB не может корректно отсоединиться от зависшего устройства
- VSCode ждет завершения GDB, но процесс зависает

### 2. Неправильная последовательность завершения
- `postDebugTask` пытается убить OpenOCD, но GDB еще не отсоединился
- OpenOCD продолжает работать в фоне

### 3. Конфигурация attach вместо launch
- Режим `attach` не завершает процесс автоматически
- Требуется явное отсоединение

## Внесенные исправления

### 1. Добавление postDebugCommands в launch.json
```json
{
    "postDebugCommands": [
        "monitor shutdown"
    ]
}
```
**Цель:** Корректно завершить OpenOCD перед остановкой отладки.

### 2. Улучшение задачи Stop OpenOCD в tasks.json
```json
{
    "command": "pkill",
    "args": ["-f", "openocd"]
}
```
**Цель:** Более надежное завершение OpenOCD процесса.

## Дополнительные решения

### 1. Использование кнопки "Disconnect"
В VSCode вместо кнопки "Stop" используйте кнопку "Disconnect" (если доступна) для отсоединения от целевого устройства.

### 2. Ручное завершение процессов
Если отладка зависла:
```bash
# Найти и завершить процессы
ps aux | grep openocd
kill -9 <PID_openocd>

# Или принудительно
pkill -9 -f openocd
```

### 3. Проверка состояния устройства
```bash
# Проверить, слушает ли порт 3333
netstat -tlnp | grep 3333

# Если да, завершить OpenOCD
pkill -f openocd
```

### 4. Альтернативная конфигурация
Если проблема persists, рассмотрите изменение на `request: "launch"`:
```json
{
    "request": "launch",
    "servertype": "openocd",
    "configFiles": ["openocd.cfg"]
}
```

## Профилактика

### 1. Мониторинг состояния
Добавьте в код проверку состояния FreeRTOS:
```c
// В main.c или задаче
if (xTaskGetSchedulerState() == taskSCHEDULER_RUNNING) {
    LOG_Printf("Scheduler running OK\n");
} else {
    LOG_Printf("Scheduler not running!\n");
}
```

### 2. Проверка HardFault
Регулярно проверяйте регистры в отладчике:
```gdb
(gdb) info registers
(gdb) x/16xw $sp  # Проверка стека
```

### 3. Использование watchdog
Добавьте watchdog timer для перезагрузки при зависании.

## Тестирование исправлений

1. **Перезапустите VSCode**
2. **Очистите проект:** `make clean && make`
3. **Запустите отладку**
4. **Попробуйте завершить:** Используйте "Stop" или "Disconnect"
5. **Проверьте процессы:** `ps aux | grep openocd` - должно быть пусто

## Заключение

Проблема выхода из отладки была вызвана HardFault в программе и неправильной последовательностью завершения. Внесенные исправления должны решить проблему:

- `postDebugCommands` обеспечивает корректное завершение OpenOCD
- Улучшенная задача `Stop OpenOCD` надежно завершает процесс
- Рекомендации по профилактике предотвращают повторение проблемы

Если проблема persists, рассмотрите исправление HardFault в приложении FreeRTOS.
