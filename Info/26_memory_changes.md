# Изменения конфигурации памяти FreeRTOS

## Выполненные изменения

### 1. Увеличение размера кучи (Heap)
**Файл:** `Core/Inc/FreeRTOSConfig.h`
**Изменение:**
```c
// Было:
#define configTOTAL_HEAP_SIZE ((size_t)15360)  // 15 КБ

// Стало:
#define configTOTAL_HEAP_SIZE ((size_t)20480)  // 20 КБ
```
**Обоснование:** Дополнительный запас для динамических аллокаций USB, touchscreen и будущих расширений.

### 2. Увеличение минимального размера стека
**Файл:** `Core/Inc/FreeRTOSConfig.h`
**Изменение:**
```c
// Было:
#define configMINIMAL_STACK_SIZE ((uint16_t)128)  // 128 слов = 512 байт

// Стало:
#define configMINIMAL_STACK_SIZE ((uint16_t)256)  // 256 слов = 1 КБ
```
**Обоснование:** Idle task требует больше стека для HAL функций.

### 3. Увеличение стека Default Task
**Файл:** `Core/Src/freertos.c`
**Изменение:**
```c
// Было:
osThreadDef(defaultTask, StartDefaultTask, osPriorityNormal, 0, 128);

// Стало:
osThreadDef(defaultTask, StartDefaultTask, osPriorityNormal, 0, 256);
```
**Обоснование:** Основная задача с инициализацией USB и дисплея требует больше стека.

### 4. Изменение Linker Script
**Файл:** `STM32F411CEUx_FLASH.ld`
**Изменения:**
```ld
// Было:
_Min_Heap_Size = 0x400;      /* 1024 байт */
_Min_Stack_Size = 0x800;     /* 2048 байт */

// Стало:
_Min_Heap_Size = 0x800;      /* 2048 байт */
_Min_Stack_Size = 0x1000;    /* 4096 байт */
```
**Обоснование:** Увеличение проверочных значений для предотвращения переполнения.

## Результаты изменений

### Новые значения памяти

| Параметр | Было | Стало | Прирост |
|----------|------|-------|---------|
| `configTOTAL_HEAP_SIZE` | 15360 байт | 20480 байт | +5120 байт |
| `configMINIMAL_STACK_SIZE` | 512 байт | 1024 байт | +512 байт |
| Default Task stack | 512 байт | 1024 байт | +512 байт |
| `_Min_Heap_Size` | 1024 байт | 2048 байт | +1024 байт |
| `_Min_Stack_Size` | 2048 байт | 4096 байт | +2048 байт |

### Общее использование памяти после изменений

- **Idle Task:** 1024 байт (вместо 512)
- **Default Task:** 1024 байт (вместо 512)
- **Touch Task:** 2048 байт (без изменений)
- **Calibration Task:** 2048 байт (без изменений)
- **Итого стек задач:** 6144 байт (вместо 5120)
- **Куча (Heap):** 20480 байт (вместо 15360)
- **Общее выделение:** 26624 байт (вместо 20480)
- **Свободный RAM:** ~101 КБ (вместо ~107 КБ)

## Файлы, которые были изменены

1. `Core/Inc/FreeRTOSConfig.h` - Конфигурация FreeRTOS
2. `Core/Src/freertos.c` - Создание задач
3. `STM32F411CEUx_FLASH.ld` - Linker script

## Следующие шаги

1. **Пересборка проекта** - Выполнить `make clean && make`
2. **Тестирование** - Проверить работу с новыми настройками
3. **Мониторинг** - Добавить функции отслеживания использования стека и кучи
4. **Оптимизация** - При необходимости скорректировать размеры на основе реального использования

## Безопасность

Изменения увеличивают использование RAM, но остаются в пределах доступной памяти (128 КБ). Новые размеры предотвращают stack overflow и heap exhaustion.
